<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Study Trainer</title>
  <meta name="theme-color" content="#0B1220"/>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.16);
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.55);
      --brand:#6EA8FF;
      --brand2:#9B7BFF;
      --good:#5EE6A8;
      --warn:#FFD66E;
      --bad:#FF6EA6;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow2: 0 10px 24px rgba(0,0,0,.45);
      --r16:16px;
      --r20:20px;
      --r24:24px;
      --pad: clamp(16px, 2.4vw, 22px);
      --max: 1040px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(110,168,255,.20), transparent 60%),
        radial-gradient(900px 650px at 90% 10%, rgba(155,123,255,.18), transparent 55%),
        radial-gradient(900px 650px at 50% 110%, rgba(94,230,168,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{ color:inherit; }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 0 var(--pad); }

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(11,18,32,.86), rgba(11,18,32,.60));
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .topbarInner{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px var(--pad);
      gap: 12px; flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .logo{
      width:40px; height:40px; border-radius: 14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.45), transparent 60%),
        linear-gradient(135deg, rgba(110,168,255,.95), rgba(155,123,255,.95));
      box-shadow: 0 12px 26px rgba(110,168,255,.18);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius: 10px;
      background: rgba(11,18,32,.35);
      border: 1px solid rgba(255,255,255,.18);
    }
    .brandTitle{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brandTitle b{ font-size: 15px; letter-spacing:.2px; }
    .brandTitle span{ font-size: 12.5px; color:var(--muted); margin-top:4px; }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .tabBtn{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
      display:flex; align-items:center; gap:8px;
    }
    .tabBtn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
    .tabBtn:active{ transform: translateY(1px) scale(.99); }
    .tabBtn.active{
      background: linear-gradient(135deg, rgba(110,168,255,.22), rgba(155,123,255,.18));
      border-color: rgba(110,168,255,.45);
      box-shadow: 0 0 0 4px rgba(110,168,255,.10);
    }
    .chip{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 6px 10px;
      border-radius: 999px;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }

    /* Layout */
    .hero{
      padding: 26px 0 10px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 860px){
      .hero{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: var(--r24);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .cardInner{ padding: 18px; }
    .h1{
      margin:0;
      font-size: clamp(22px, 2.4vw, 28px);
      letter-spacing:-.3px;
    }
    .sub{
      margin:10px 0 0 0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .stat{
      padding: 14px;
      border-radius: var(--r20);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }
    .stat b{ display:block; font-size: 14px; }
    .stat span{ color: var(--muted); font-size: 12.5px; }

    .ringWrap{
      display:flex; gap:16px; align-items:center;
    }
    .ring{
      width: 86px; height: 86px;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,.45));
    }
    .ringText{
      display:flex; flex-direction:column;
    }
    .ringText b{ font-size: 18px; }
    .ringText span{ color:var(--muted); font-size: 12.5px; margin-top:4px; }

    .panel{
      margin-top: 14px;
    }
    .panelHeader{
      display:flex; justify-content:space-between; align-items:flex-end;
      gap: 10px; flex-wrap:wrap;
      padding: 18px 18px 0 18px;
    }
    .panelHeader h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .panelHeader p{
      margin:6px 0 0 0; color:var(--muted); font-size: 13px;
    }

    .grid{
      display:grid; grid-template-columns: 1fr 1fr; gap: 12px;
      padding: 16px 18px 18px;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      margin-bottom: 7px;
      font-size: 12.5px;
      color: var(--muted);
    }

    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(7,10,18,.55);
      color: var(--text);
      outline:none;
      transition: border-color .2s ease, box-shadow .2s ease, background .2s ease;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(110,168,255,.55);
      box-shadow: 0 0 0 4px rgba(110,168,255,.12);
      background: rgba(7,10,18,.70);
    }

    .btnRow{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 0 18px 18px;
    }
    .btn{
      border-radius: 999px;
      padding: 11px 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      border-color: rgba(110,168,255,.55);
      background: linear-gradient(135deg, rgba(110,168,255,.36), rgba(155,123,255,.22));
      box-shadow: 0 10px 30px rgba(110,168,255,.10);
    }
    .btn.danger{
      border-color: rgba(255,110,166,.45);
      background: rgba(255,110,166,.12);
    }
    .btn .icon{ opacity:.9; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }

    .list{
      padding: 0 18px 18px;
    }
    .item{
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--r20);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.55);
      display:flex; justify-content:space-between; gap: 12px; align-items:flex-start;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.16);
      background: rgba(7,10,18,.65);
    }
    .item b{ display:block; font-size: 14.5px; }
    .item small{ color: var(--muted); font-size: 12.5px; display:block; margin-top:5px; line-height: 1.35; }

    .session{
      margin-top: 10px;
      padding: 12px;
      border-radius: var(--r20);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,10,18,.55);
    }
    .session h4{ margin:0; font-size: 14.5px; letter-spacing:.1px; }
    .session .meta{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 40;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.82);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      color: var(--text);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      display:flex; align-items:center; gap:10px;
      max-width: min(92vw, 720px);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-2px); }

    .kbd{
      font-size: 12px;
      padding: 2px 8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      color: var(--muted);
    }

    .footer{
      padding: 24px 0 50px;
      color: var(--muted2);
      font-size: 12.5px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="brandTitle">
          <b>Study Trainer</b>
          <span>Feels like a coach. Works like a planner. Saves locally.</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="materials">üìö Materials</button>
        <button class="tabBtn" data-tab="intake">üß† Intake</button>
        <button class="tabBtn" data-tab="plan">üóìÔ∏è Plan</button>
        <button class="tabBtn" data-tab="checkin">‚úÖ Check-in</button>
      </div>

      <div class="chip" id="headerChip">‚ú® Add topics to start</div>
    </div>
  </div>

  <main class="wrap">
    <section class="hero">
      <div class="card">
        <div class="cardInner">
          <h1 class="h1">A study plan that actually adapts to you.</h1>
          <p class="sub">
            Add topics, tell it your time, and it‚Äôll schedule smart sessions with techniques that evolve as you check in.
            It‚Äôs not ‚Äúperfect.‚Äù It‚Äôs consistent. And that wins exams.
          </p>

          <div class="panel" style="margin-top:14px;">
            <div class="ringWrap">
              <svg class="ring" viewBox="0 0 120 120">
                <defs>
                  <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
                    <stop offset="0" stop-color="rgba(110,168,255,.95)"/>
                    <stop offset="1" stop-color="rgba(155,123,255,.95)"/>
                  </linearGradient>
                </defs>
                <circle cx="60" cy="60" r="46" stroke="rgba(255,255,255,.10)" stroke-width="12" fill="none"/>
                <circle id="ringProg" cx="60" cy="60" r="46"
                        stroke="url(#g)" stroke-width="12" fill="none"
                        stroke-linecap="round"
                        stroke-dasharray="289"
                        stroke-dashoffset="289"
                        transform="rotate(-90 60 60)"/>
                <text id="ringPct" x="60" y="66" text-anchor="middle" font-size="22" fill="rgba(234,240,255,.92)" font-weight="700">0%</text>
              </svg>

              <div class="ringText">
                <b id="progressLabel">Plan progress</b>
                <span id="progressSub">Generate a plan, then check in to watch this climb.</span>
                <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                  <span class="pill" id="pillTopics">üìå 0 topics</span>
                  <span class="pill" id="pillSessions">‚è±Ô∏è 0 sessions</span>
                  <span class="pill" id="pillDone">‚úÖ 0 done</span>
                </div>
              </div>
            </div>

            <div class="stats" style="margin-top:14px;">
              <div class="stat">
                <b id="statFocus">Today‚Äôs focus: ‚Äî</b>
                <span id="statFocusSub">Go to Check-in to see your next session.</span>
              </div>
              <div class="stat">
                <b id="statMode">Technique mix: Balanced</b>
                <span id="statModeSub">Set your style in Intake.</span>
              </div>
            </div>
          </div>

          <div style="margin-top:14px; color:var(--muted2); font-size:12.5px;">
            Tip: use <span class="kbd">Ctrl</span> + <span class="kbd">F</span> to find topics quickly once you add a bunch.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardInner">
          <h2 style="margin:0; font-size:16px;">Quick actions</h2>
          <p class="sub" style="margin-top:8px;">Fast path: add ‚Üí intake ‚Üí plan ‚Üí check-in.</p>

          <div style="display:grid; gap:10px; margin-top:14px;">
            <button class="btn primary" onclick="showTab('materials')"><span class="icon">‚ûï</span> Add topics</button>
            <button class="btn" onclick="showTab('intake')"><span class="icon">üß†</span> Do intake</button>
            <button class="btn" onclick="showTab('plan')"><span class="icon">üóìÔ∏è</span> View plan</button>
            <button class="btn" onclick="showTab('checkin')"><span class="icon">‚úÖ</span> Check in</button>
          </div>

          <div class="card" style="margin-top:14px; background:rgba(255,255,255,.05); border-radius:var(--r24);">
            <div class="cardInner" style="padding:14px;">
              <b style="font-size:14px;">Private by default</b>
              <p class="sub" style="margin-top:6px;">
                Everything stays on your device (localStorage). No accounts. No tracking.
              </p>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- MATERIALS -->
    <section id="materials" class="card" style="margin-top:14px;">
      <div class="panelHeader">
        <div>
          <h2>Materials</h2>
          <p>Add topics/chapters. The trainer schedules and re-schedules based on how you do.</p>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Topic name</label>
          <input id="topicName" placeholder="e.g., T cell activation, Chapter 7, Stoichiometry" />
        </div>
        <div>
          <label>Topic type</label>
          <select id="topicType">
            <option value="concept">Concept-heavy</option>
            <option value="memorization">Memorization</option>
            <option value="problem">Problem-solving</option>
          </select>
        </div>

        <div>
          <label>Importance (1‚Äì5)</label>
          <input id="importance" type="number" min="1" max="5" value="3"/>
        </div>
        <div>
          <label>Difficulty (1‚Äì5)</label>
          <input id="difficulty" type="number" min="1" max="5" value="3"/>
        </div>
      </div>

      <div class="btnRow">
        <button class="btn primary" id="addTopic"><span class="icon">‚ûï</span> Add topic</button>
        <button class="btn" id="seedExample"><span class="icon">‚ú®</span> Add example set</button>
        <button class="btn danger" id="wipeAll"><span class="icon">üßº</span> Wipe all data</button>
      </div>

      <div class="list" id="topicsList"></div>
    </section>

    <!-- INTAKE -->
    <section id="intake" class="card" style="margin-top:14px; display:none;">
      <div class="panelHeader">
        <div>
          <h2>Intake</h2>
          <p>Tell it your time and preferences. It‚Äôll act like a coach and adjust the plan as you go.</p>
        </div>
      </div>

      <div class="grid">
        <div>
          <label>Deadline</label>
          <input id="deadline" type="date" />
        </div>
        <div>
          <label>Study days per week</label>
          <input id="daysPerWeek" type="number" min="1" max="7" value="5" />
        </div>
        <div>
          <label>Minutes per study day</label>
          <input id="minsPerDay" type="number" min="15" max="600" value="60" />
        </div>
        <div>
          <label>Preferred style</label>
          <select id="style">
            <option value="balanced">Balanced</option>
            <option value="practice">More practice questions</option>
            <option value="recall">More active recall</option>
            <option value="reading">More reading/notes</option>
          </select>
        </div>
      </div>

      <div class="panelHeader" style="padding-top:0;">
        <div>
          <h2 style="font-size:15px;">Baseline confidence (optional, but makes it feel *personal*)</h2>
          <p>Rate each topic 0‚Äì100 so it knows what to hit first.</p>
        </div>
      </div>
      <div class="list" id="baselineList" style="padding-top:0;"></div>

      <div class="btnRow">
        <button class="btn primary" id="saveIntake"><span class="icon">üíæ</span> Save intake</button>
        <button class="btn" id="generatePlan"><span class="icon">üß†</span> Generate plan</button>
      </div>
    </section>

    <!-- PLAN -->
    <section id="plan" class="card" style="margin-top:14px; display:none;">
      <div class="panelHeader">
        <div>
          <h2>Plan</h2>
          <p>Built from your time + deadline. Updates as your check-ins roll in.</p>
        </div>
      </div>
      <div class="list" id="planOutput"></div>
    </section>

    <!-- CHECK-IN -->
    <section id="checkin" class="card" style="margin-top:14px; display:none;">
      <div class="panelHeader">
        <div>
          <h2>Check-in</h2>
          <p>Rate the session. Hard = more review. Easy = less time wasted. That‚Äôs the whole magic.</p>
        </div>
      </div>

      <div class="list" id="nextSession"></div>

      <div class="footer">
        Built to be satisfying: tiny wins, clear progress, no guilt. ü´∂
      </div>
    </section>
  </main>

  <div class="toast" id="toast">Saved.</div>

<script>
  // ======= STORAGE =======
  const KEY = "study_trainer_modern_v1";
  const todayISO = () => new Date().toISOString().slice(0,10);

  function loadState(){
    const raw = localStorage.getItem(KEY);
    if(!raw){
      return {
        topics: [],
        intake: { deadline: "", daysPerWeek: 5, minsPerDay: 60, style: "balanced", baseline: {} },
        plan: [],
        history: []
      };
    }
    try { return JSON.parse(raw); } catch { return null; }
  }
  function saveState(s){ localStorage.setItem(KEY, JSON.stringify(s)); }

  let state = loadState() || loadState();

  // ======= TOAST =======
  const toast = document.getElementById("toast");
  let toastT = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toastT);
    toastT = setTimeout(()=> toast.classList.remove("show"), 1600);
  }

  // ======= TABS =======
  const tabBtns = [...document.querySelectorAll(".tabBtn[data-tab]")];
  const sections = ["materials","intake","plan","checkin"].reduce((acc,id)=> (acc[id]=document.getElementById(id), acc),{});

  function showTab(id){
    tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === id));
    Object.entries(sections).forEach(([k,el]) => el.style.display = (k===id ? "block" : "none"));
    if(id==="intake") renderBaseline();
    if(id==="materials") renderTopics();
    if(id==="plan") renderPlan();
    if(id==="checkin") renderNextSession();
    updateHeader();
    window.scrollTo({top:0, behavior:"smooth"});
  }
  window.showTab = showTab;
  tabBtns.forEach(b => b.addEventListener("click", () => showTab(b.dataset.tab)));

  // ======= UI ELEMENTS =======
  const topicsList = document.getElementById("topicsList");
  const baselineList = document.getElementById("baselineList");
  const planOutput = document.getElementById("planOutput");
  const nextSession = document.getElementById("nextSession");

  // Header stats elements
  const headerChip = document.getElementById("headerChip");
  const ringProg = document.getElementById("ringProg");
  const ringPct = document.getElementById("ringPct");
  const pillTopics = document.getElementById("pillTopics");
  const pillSessions = document.getElementById("pillSessions");
  const pillDone = document.getElementById("pillDone");
  const statFocus = document.getElementById("statFocus");
  const statFocusSub = document.getElementById("statFocusSub");
  const statMode = document.getElementById("statMode");
  const statModeSub = document.getElementById("statModeSub");

  // ======= HELPERS =======
  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
  function escapeHtml(str){ return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function daysBetween(a,b){
    const A = new Date(a), B = new Date(b);
    const ms = Math.max(0, B - A);
    return Math.ceil(ms / (1000*60*60*24));
  }
  function addDaysISO(startISO, days){
    const dt = new Date(startISO + "T00:00:00");
    dt.setDate(dt.getDate() + days);
    return dt.toISOString().slice(0,10);
  }

  function computeProgress(){
    const all = state.plan.flatMap(d => d.sessions);
    const done = all.filter(s => s.completed).length;
    const total = all.length;
    const pct = total ? Math.round((done/total)*100) : 0;
    return { total, done, pct };
  }

  function getNextPendingSession(){
    for(const day of state.plan){
      for(const s of day.sessions){
        if(!s.completed) return s;
      }
    }
    return null;
  }

  function updateHeader(){
    // chip
    if(state.topics.length === 0) headerChip.textContent = "‚ú® Add topics to start";
    else if(!state.intake.deadline) headerChip.textContent = "üß† Do intake next";
    else if(!state.plan.length) headerChip.textContent = "üóìÔ∏è Generate your plan";
    else headerChip.textContent = "‚úÖ Check in to adapt";

    // pills + ring
    const { total, done, pct } = computeProgress();
    pillTopics.textContent = `üìå ${state.topics.length} topic${state.topics.length===1?"":"s"}`;
    pillSessions.textContent = `‚è±Ô∏è ${total} session${total===1?"":"s"}`;
    pillDone.textContent = `‚úÖ ${done} done`;

    const C = 289; // circumference-ish from earlier dasharray
    const offset = C - (C * pct / 100);
    ringProg.style.strokeDasharray = String(C);
    ringProg.style.strokeDashoffset = String(offset);
    ringPct.textContent = `${pct}%`;

    // focus box
    const nxt = getNextPendingSession();
    if(nxt){
      statFocus.textContent = `Today‚Äôs focus: ${nxt.topicName}`;
      statFocusSub.textContent = `${nxt.technique} ‚Ä¢ ${nxt.minutes} min ‚Ä¢ scheduled ${nxt.scheduledFor}`;
    } else {
      statFocus.textContent = "Today‚Äôs focus: ‚Äî";
      statFocusSub.textContent = state.plan.length ? "No pending sessions üéâ (or regenerate a plan)." : "Generate a plan first.";
    }

    // mode box
    const style = state.intake.style || "balanced";
    const label = ({
      balanced: "Balanced",
      practice: "Practice-heavy",
      recall: "Active-recall heavy",
      reading: "Reading/notes heavy"
    })[style] || "Balanced";
    statMode.textContent = `Technique mix: ${label}`;
    statModeSub.textContent = state.intake.deadline ? `Deadline: ${state.intake.deadline}` : "Set your deadline in Intake.";
  }

  // ======= MATERIALS =======
  function addTopic(topic){
    state.topics.push({
      id: crypto.randomUUID(),
      name: topic.name,
      type: topic.type,
      importance: clamp(+topic.importance,1,5),
      difficulty: clamp(+topic.difficulty,1,5),
      confidence: 50,
      lastReviewed: null,
      reps: 0
    });
    saveState(state);
    renderTopics();
    renderBaseline();
    updateHeader();
    showToast("Topic added ‚ú®");
  }

  document.getElementById("addTopic").addEventListener("click", () => {
    const name = document.getElementById("topicName").value.trim();
    const type = document.getElementById("topicType").value;
    const importance = document.getElementById("importance").value;
    const difficulty = document.getElementById("difficulty").value;
    if(!name) return showToast("Add a topic name first.");
    addTopic({name,type,importance,difficulty});
    document.getElementById("topicName").value = "";
  });

  document.getElementById("seedExample").addEventListener("click", () => {
    const ex = [
      ["Cell signaling basics","concept",4,3],
      ["Key terms & definitions","memorization",3,3],
      ["Practice problems set A","problem",5,4],
      ["Weak areas review","concept",4,4],
    ];
    ex.forEach(([name,type,i,d]) => addTopic({name,type,importance:i,difficulty:d}));
    showToast("Example topics added.");
  });

  document.getElementById("wipeAll").addEventListener("click", () => {
    if(confirm("Wipe everything? This removes topics, intake, plan, and history.")){
      localStorage.removeItem(KEY);
      state = loadState();
      renderTopics(); renderBaseline(); renderPlan(); renderNextSession(); updateHeader();
      showTab("materials");
      showToast("Wiped. Fresh start.");
    }
  });

  function renderTopics(){
    if(state.topics.length === 0){
      topicsList.innerHTML = `<div class="item"><div><b>No topics yet</b><small>Add a few above. Keep them small and specific.</small></div></div>`;
      return;
    }
    topicsList.innerHTML = state.topics.map(t => `
      <div class="item">
        <div>
          <b>${escapeHtml(t.name)}</b>
          <small>
            ${t.type} ‚Ä¢ importance ${t.importance}/5 ‚Ä¢ difficulty ${t.difficulty}/5 ‚Ä¢ confidence ${Math.round(t.confidence)}%
          </small>
        </div>
        <button class="btn danger" onclick="deleteTopic('${t.id}')"><span class="icon">üóëÔ∏è</span> Delete</button>
      </div>
    `).join("");
  }

  window.deleteTopic = (id) => {
    state.topics = state.topics.filter(t => t.id !== id);
    delete state.intake.baseline[id];
    // also remove from plan sessions
    state.plan = state.plan.map(d => ({...d, sessions: d.sessions.filter(s => s.topicId !== id)})).filter(d => d.sessions.length>0);
    saveState(state);
    renderTopics(); renderBaseline(); renderPlan(); renderNextSession(); updateHeader();
    showToast("Deleted.");
  };

  // ======= INTAKE =======
  function renderBaseline(){
    const intake = state.intake;
    document.getElementById("deadline").value = intake.deadline || "";
    document.getElementById("daysPerWeek").value = intake.daysPerWeek ?? 5;
    document.getElementById("minsPerDay").value = intake.minsPerDay ?? 60;
    document.getElementById("style").value = intake.style ?? "balanced";

    if(state.topics.length === 0){
      baselineList.innerHTML = `<div class="item"><div><b>Add topics first</b><small>Once you have topics, you can rate confidence here.</small></div></div>`;
      return;
    }

    baselineList.innerHTML = state.topics.map(t => {
      const v = intake.baseline[t.id] ?? t.confidence ?? 50;
      return `
        <div class="item" style="align-items:center;">
          <div style="flex:1;">
            <b>${escapeHtml(t.name)}</b>
            <small>Confidence (0‚Äì100). Lower = it schedules this earlier + more often.</small>
          </div>
          <div style="width:180px;">
            <input type="number" min="0" max="100" value="${v}"
              onchange="setBaseline('${t.id}', this.value)" />
          </div>
        </div>
      `;
    }).join("");
  }

  window.setBaseline = (id, val) => {
    state.intake.baseline[id] = clamp(+val,0,100);
    saveState(state);
    updateHeader();
  };

  document.getElementById("saveIntake").addEventListener("click", () => {
    state.intake.deadline = document.getElementById("deadline").value;
    state.intake.daysPerWeek = clamp(+document.getElementById("daysPerWeek").value,1,7);
    state.intake.minsPerDay = clamp(+document.getElementById("minsPerDay").value,15,600);
    state.intake.style = document.getElementById("style").value;

    // apply baseline to topics
    state.topics.forEach(t => {
      const b = state.intake.baseline[t.id];
      if(typeof b === "number") t.confidence = b;
    });

    saveState(state);
    updateHeader();
    showToast("Intake saved üíæ");
  });

  // ======= PLANNER =======
  function shouldStudyOnDay(dayIndex, daysPerWeek){
    return (dayIndex % 7) < daysPerWeek;
  }

  function pickTechnique(topicType, style){
    const pool = {
      concept: ["Active Recall (no notes)", "Feynman Explain", "Blurting + Fix Gaps", "Spaced Review"],
      memorization: ["Flashcards", "Active Recall (no notes)", "Spaced Review", "Teach Back"],
      problem: ["Practice Problems", "Error Log Review", "Mixed Practice", "Spaced Review"]
    }[topicType] || ["Active Recall (no notes)", "Spaced Review"];

    if(style === "practice") return pool.includes("Practice Problems") ? "Practice Problems" : pool[0];
    if(style === "recall") return "Active Recall (no notes)";
    if(style === "reading") return "Feynman Explain";
    return pool[Math.floor(Math.random()*pool.length)];
  }

  function topicScore(t){
    const imp = t.importance;
    const diff = t.difficulty;
    const conf = (100 - (t.confidence ?? 50)) / 100;
    const last = t.lastReviewed ? daysBetween(t.lastReviewed, todayISO()) : 7;
    const spacedBoost = Math.min(1.5, 0.2 + (last/7));
    return (imp*0.9 + diff*0.8) * (1 + conf) * spacedBoost;
  }

  function generatePlan(){
    const deadline = state.intake.deadline;
    const totalDays = daysBetween(todayISO(), deadline);
    if(totalDays <= 0) return [];

    const minsPerDay = state.intake.minsPerDay;
    const blocks = Math.max(1, Math.round(minsPerDay / 25));
    const daysPerWeek = state.intake.daysPerWeek;

    const topics = state.topics.map(t => ({...t}));

    const plan = [];
    for(let d=0; d<totalDays; d++){
      if(!shouldStudyOnDay(d, daysPerWeek)) continue;

      topics.sort((a,b)=> topicScore(b)-topicScore(a));
      const chosen = topics.slice(0, Math.min(3, topics.length));

      const sessions = [];
      for(let b=0; b<blocks; b++){
        const topic = chosen[b % chosen.length];
        const technique = pickTechnique(topic.type, state.intake.style);
        const date = addDaysISO(todayISO(), d);

        sessions.push({
          id: crypto.randomUUID(),
          topicId: topic.id,
          topicName: topic.name,
          technique,
          minutes: 25,
          scheduledFor: date,
          completed: false
        });

        topic.lastReviewed = date;
        topic.reps = (topic.reps ?? 0) + 1;
      }

      plan.push({ date: addDaysISO(todayISO(), d), sessions });
    }
    return plan;
  }

  function renderPlan(){
    if(!state.plan || state.plan.length === 0){
      planOutput.innerHTML = `<div class="item"><div><b>No plan yet</b><small>Go to Intake ‚Üí Generate plan.</small></div></div>`;
      updateHeader();
      return;
    }

    planOutput.innerHTML = state.plan.map(day => `
      <div class="item" style="flex-direction:column; align-items:stretch;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <b>${day.date}</b>
          <span class="pill">‚è±Ô∏è ${day.sessions.length} session(s)</span>
        </div>
        ${day.sessions.map(s => `
          <div class="session">
            <h4>${escapeHtml(s.topicName)}</h4>
            <div class="meta">
              <span class="pill">üß© ${escapeHtml(s.technique)}</span>
              <span class="pill">‚è≥ ${s.minutes} min</span>
              <span class="pill">${s.completed ? "‚úÖ completed" : "‚è≥ pending"}</span>
            </div>
          </div>
        `).join("")}
      </div>
    `).join("");

    updateHeader();
  }

  document.getElementById("generatePlan").addEventListener("click", () => {
    document.getElementById("saveIntake").click();
    if(!state.intake.deadline) return showToast("Set a deadline date first.");
    if(state.topics.length === 0) return showToast("Add some topics first.");

    state.plan = generatePlan();
    saveState(state);
    renderPlan();
    showTab("plan");
    showToast("Plan generated üóìÔ∏è");
  });

  // ======= CHECK-IN =======
  function renderNextSession(){
    const s = getNextPendingSession();
    if(!s){
      nextSession.innerHTML = `<div class="item"><div><b>No pending sessions</b><small>${state.plan.length ? "You‚Äôre caught up üéâ Regenerate your plan anytime." : "Generate a plan first."}</small></div></div>`;
      updateHeader();
      return;
    }

    nextSession.innerHTML = `
      <div class="item" style="flex-direction:column; align-items:stretch;">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
          <div>
            <b>Next session: ${escapeHtml(s.topicName)}</b>
            <small>${s.technique} ‚Ä¢ ${s.minutes} min ‚Ä¢ scheduled ${s.scheduledFor}</small>
          </div>
          <span class="pill">Make it easy to win today</span>
        </div>

        <div class="btnRow" style="padding: 12px 0 0 0;">
          <button class="btn" style="border-color:rgba(94,230,168,.45); background:rgba(94,230,168,.10);" onclick="completeSession('${s.id}', 'easy')">
            <span class="icon">‚úÖ</span> Easy
          </button>
          <button class="btn" style="border-color:rgba(255,214,110,.45); background:rgba(255,214,110,.10);" onclick="completeSession('${s.id}', 'medium')">
            <span class="icon">üòê</span> Medium
          </button>
          <button class="btn" style="border-color:rgba(255,110,166,.45); background:rgba(255,110,166,.10);" onclick="completeSession('${s.id}', 'hard')">
            <span class="icon">üß®</span> Hard
          </button>
        </div>

        <div style="margin-top:10px; color:var(--muted2); font-size:12.5px;">
          The trainer adapts: hard topics come back sooner; easy topics chill out.
        </div>
      </div>
    `;

    updateHeader();
  }

  window.completeSession = (sessionId, rating) => {
    let found = null;
    for(const day of state.plan){
      for(const s of day.sessions){
        if(s.id === sessionId){
          s.completed = true;
          found = s;
          break;
        }
      }
      if(found) break;
    }
    if(!found) return;

    const t = state.topics.find(x => x.id === found.topicId);
    if(t){
      if(rating === "easy") t.confidence = clamp((t.confidence ?? 50) + 6, 0, 100);
      if(rating === "medium") t.confidence = clamp((t.confidence ?? 50) + 2, 0, 100);
      if(rating === "hard") t.confidence = clamp((t.confidence ?? 50) - 6, 0, 100);
      t.lastReviewed = todayISO();
    }

    state.history.push({ date: todayISO(), topicId: found.topicId, technique: found.technique, minutes: found.minutes, rating });
    saveState(state);

    renderPlan();
    renderNextSession();
    updateHeader();

    const msg = rating === "easy" ? "Nice. Momentum ‚úÖ" : rating === "medium" ? "Solid. Keep going üò§" : "Good catch. We‚Äôll hit it again soon üß†";
    showToast(msg);
  };

  // ======= INITIAL =======
  renderTopics();
  renderBaseline();
  renderPlan();
  renderNextSession();
  updateHeader();
</script>
</body>
</html>
